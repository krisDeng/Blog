<!DOCTYPE html>
<html lang="zh-CN">
  <head><meta name="generator" content="Hexo 3.8.0">
    
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



  <meta name="description" content="iOS 推送注册流程">




  <meta name="keywords" content="OC、Swift,">





  <link rel="alternate" href="../../../../default" title="Kris的博客">




  <link rel="shortcut icon" type="image/x-icon" href="../../../../favicon.ico?v=1.1">



<link rel="canonical" href="https://krisdeng.github.io/2017/01/02/iOS 推送注册流程/">


<meta name="description" content="1.注册证书 首先苹果证书主要分为上线证书和测试证书，相信都有所了解 在此不再累赘了 ，接下来就开始制作吧  一 CSR文件首先我们要有生成一个Certificate Signing Request(也就是CSR)的请求文件。在应用程序里的使用工具中找到钥匙串访问。">
<meta name="keywords" content="OC、Swift">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS 推送注册流程">
<meta property="og:url" content="https://krisdeng.github.io/2017/01/02/iOS 推送注册流程/index.html">
<meta property="og:site_name" content="Kris的博客">
<meta property="og:description" content="1.注册证书 首先苹果证书主要分为上线证书和测试证书，相信都有所了解 在此不再累赘了 ，接下来就开始制作吧  一 CSR文件首先我们要有生成一个Certificate Signing Request(也就是CSR)的请求文件。在应用程序里的使用工具中找到钥匙串访问。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/6F5252D036C67275B6F1ED51216A7DCF.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/D171D195163FF9D53581680F488A1F9D.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/A13C0DF9F322AAC4275649308AD390EF.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/0E4973A87440EC36FB307235D77D853B.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/2BBB09ED7C4AD9AB8B8C5AE4DFF802E0.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/424A08E9DCBFFBE29042C7653DFAD263.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/0A4464334BDB50B57BB795C28DA77403.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/5CFF1C206EE403CFEFE90ECC9196A61E.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/1138DA458D9F98B412A534EDC67EF62D.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/7488EAE94C26333D164591E867C050BD.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/ED10A0B82776F3A33F02B6B62D5085CD.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/B75DC981755C5C2780AA0759290DD4EE.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/A424311534417FE21690843D53D1034E.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/29728811AE876425BDCB9A4C5E146F7E.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/A6DACF180C78E97FDEAED1B11372351D.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/B5586711BC024E66B6D3AEE7EDCCC546.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/2F17D09A6372D5EE7AE22ADD5F577041.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/A8C23C9CF3594395B1C74FE992DBE97F.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/A2ABB3A06682CF11E3AB2EDE29C0080E.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/109FEF44E73E7F28BDA49F0886435CEE.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/55346ABF620F09E29AAA18FE964C9BD5.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/BB88E79AF9A21A48D27310EE6F917DFF.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/3156B46F23A5C965ED0CE129981CE9CD.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/7C001F73F270D12AB67BCB2CE80431F2.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/CF7AFA06CF68B541FA57E23FC4404C80.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/88681E6EB895AC2C22562F2876BBEBBE.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/EEB7844AEF2C2D9793AD71E0CCB182E5.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/7D192795E857BD7FF32D2BF645F2C02C.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/C3CF76428AC05EAD0320038CF2CF5F63.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/AA1192271D6864D30F30F453C53659CC.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/1CB89172D17E5838CB29FB00283756B4.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/8CDF0120B031DDC8E7B53DFE35E333B7.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/43B9F1E7DA092833795711CC314AF914.png">
<meta property="og:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/DD9F27DBF3ADB5F11779CD5EB5E3C53E.png">
<meta property="og:updated_time" content="2019-01-03T13:12:11.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS 推送注册流程">
<meta name="twitter:description" content="1.注册证书 首先苹果证书主要分为上线证书和测试证书，相信都有所了解 在此不再累赘了 ，接下来就开始制作吧  一 CSR文件首先我们要有生成一个Certificate Signing Request(也就是CSR)的请求文件。在应用程序里的使用工具中找到钥匙串访问。">
<meta name="twitter:image" content="https://krisdeng.github.io/blog/2017/01/02/iOS%20推送注册流程/6F5252D036C67275B6F1ED51216A7DCF.png">


<link rel="stylesheet" type="text/css" href="../../../../css/style.css?v=1.1">
<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  



    <title> iOS 推送注册流程 - Kris的博客 </title>
  </head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="../../../../." class="logo">Kris的博客</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="">
                            
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          iOS 推送注册流程
        
      </h1>

      <time class="post-time">
          1月 02 2017
      </time>
    </header>



    
            <div class="post-content">
            <h2 id="1-注册证书"><a href="#1-注册证书" class="headerlink" title="1.注册证书"></a>1.注册证书</h2><blockquote>
<p>首先苹果证书主要分为上线证书和测试证书，相信都有所了解 在此不再累赘了 ，接下来就开始制作吧</p>
</blockquote>
<p>一 CSR文件<br>首先我们要有生成一个Certificate Signing Request(也就是CSR)的请求文件。<br>在应用程序里的使用工具中找到钥匙串访问。</p>
<a id="more"></a>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/6F5252D036C67275B6F1ED51216A7DCF.png" alt=""></p>
<p>填上你的邮箱和常用名 或者是公司关联账号，常用名要记一下，一会<br>会用到。</p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/D171D195163FF9D53581680F488A1F9D.png" alt=""></p>
<p>然后选择保存到磁盘，继续</p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/A13C0DF9F322AAC4275649308AD390EF.png" alt=""></p>
<p>Snip20160728_15.png</p>
<p>这时桌面上会有一个CertificateSigningRequest.certSigningRequest的请求文件，也就是我们说的CSR文件。在我们生成CSR文件的同时，会在钥匙串访问中生成一对秘钥，名称为刚才我们填写的常用名</p>
<p>二 下载开发证书和发布证书</p>
<p>到<a href="https://link.jianshu.com/?t=https://developer.apple.com/devcenter/ios/index.action" target="_blank" rel="noopener">https://developer.apple.com/devcenter/ios/index.action</a> 登录后,在右侧的ios Developer Program里点击iOS Provisioning Portal。<br>进入下一级页面后在左侧选择Certificates</p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/0E4973A87440EC36FB307235D77D853B.png" alt=""></p>
<p>点击红色的部分生成一个开发证书</p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/2BBB09ED7C4AD9AB8B8C5AE4DFF802E0.png" alt=""></p>
<p>点击选择文件，选择刚才我们生成到桌面的CSR请求文件。<br>注意，如果你在后面测试的时候出现了问题，请检查一下这里，这里的CSR请求文件必须是我们刚才生成的那个</p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/424A08E9DCBFFBE29042C7653DFAD263.png" alt=""></p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/0A4464334BDB50B57BB795C28DA77403.png" alt=""></p>
<p>选择完成后点击Submit提交</p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/5CFF1C206EE403CFEFE90ECC9196A61E.png" alt=""></p>
<p>提交完成后返回页面。页面会是这样的，然后我们刷新一下页面</p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/1138DA458D9F98B412A534EDC67EF62D.png" alt=""></p>
<p>刷新后会出现一个下载按钮，我们点击下载。现在我们的开发证书已经配置并下载好了，发布证书的配置过程和开发证书是一致的，不再赘述。下载完后双击，会跳到钥匙串访问里。这就是我们之后要进行测的证书</p>
<p>三 配置AppID，配置并下载SSL证书<br>点击左侧的App IDs，找到我们要做推送功能的程序的id（如果没有的话要先New一个。注意：这里的App ID必须不能是通配的，通配的不可以做推送）<br>点击Configure</p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/7488EAE94C26333D164591E867C050BD.png" alt=""></p>
<p>进入后默认推送功能是关闭的，我们需要把推送功能打开</p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/ED10A0B82776F3A33F02B6B62D5085CD.png" alt=""></p>
<p>选中打开后，点击右边灰色的Configure按钮</p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/B75DC981755C5C2780AA0759290DD4EE.png" alt=""></p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/A424311534417FE21690843D53D1034E.png" alt=""></p>
<p>这里的文件同样的，还是选择我们生成在桌面上的CSR请求文件</p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/29728811AE876425BDCB9A4C5E146F7E.png" alt=""></p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/A6DACF180C78E97FDEAED1B11372351D.png" alt=""></p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/B5586711BC024E66B6D3AEE7EDCCC546.png" alt=""></p>
<p>然后点击继续</p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/2F17D09A6372D5EE7AE22ADD5F577041.png" alt=""></p>
<p>出现了我们需要的SSL证书，我们点击下载后点击Done完成。</p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/A8C23C9CF3594395B1C74FE992DBE97F.png" alt=""></p>
<p>Status状态变成了绿色可用了。这里右边的下载和上一步的下载是一样的，如果在上一步中下载了证书，便无需再次下载。此时我们有了一个名字叫aps_development.cer的SSL证书，同样，我们把他放在桌面。双击后会跳到钥匙串访问，出现我们的SSL推送证书<br>同样的，发布的SSL证书的步骤也是一样的。</p>
<p>四 下载Provisioning证书<br>在左侧选择Provisioning</p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/A2ABB3A06682CF11E3AB2EDE29C0080E.png" alt=""></p>
<p>配置好后点击提交（注意App ID要与我们刚的程序对应）</p>
<p>之后变回出现下载按钮，我们点击下载。下载后双击，并将我们的设备上的描述文件更新一下（最好把之前的全部删除，然后再安装，防止出错）。</p>
<p>五 从钥匙串访问中导出秘钥<br>打开钥匙串访问，找到我们的专用秘钥（专用秘钥的名称就是我们在最开始生成CSR请求的时候填写的常用名）</p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/109FEF44E73E7F28BDA49F0886435CEE.png" alt=""></p>
<p>右键选择导出</p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/55346ABF620F09E29AAA18FE964C9BD5.png" alt=""></p>
<p>导出的文件名我们叫做Push</p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/BB88E79AF9A21A48D27310EE6F917DFF.png" alt=""></p>
<p>在这里需要输入一个密码来对文件进行加密。这里我们选择abc123，当然你也可以自己选择是什么，但是这个密码必须要铭记，切记！</p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/3156B46F23A5C965ED0CE129981CE9CD.png" alt=""></p>
<p>然后输入你电脑的密码，点击允许。<br>这样我们就在桌面上生成了一个Push.p12文件。</p>
<p>到此为止，我们在桌面上一共生成了三个文件。一个是CSR请求文件，一个是aps_development .cer的SSL证书文件，还有一个刚才生成的Push.p12秘钥文件。</p>
<p>现在我们的准备工作已经做完了。要开始对生成的文件进行处理了。原因上面已经解释过，因为我们的服务链接苹果服务器也是需要证书的，但是我们直接生成的证书windows系统（我们一般的服务器都是win系统的）是不识别的，所以我们需要生成一个后缀为pem的带证书带秘钥的文件。<br>六 处理证书<br>下面我们打开终端（位置：应用程序à实用工具à终端）。<br>cd到桌面，我们那三个文件所在的位置</p>
<p>1、把.cer的SSL证书转换为.pem文件，执行命令：<br>openssl x509 -in aps_development.cer -inform der -out PushChatCert.pem</p>
<p>在桌面上会生成一个PushChatCert.pem文件</p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/7C001F73F270D12AB67BCB2CE80431F2.png" alt=""></p>
<hr>
<p>2、把私钥Push.p12文件转化为.pem文件：</p>
<blockquote>
<p>openssl pkcs12 -nocerts -out PushChatKey.pem -in Push.p12</p>
</blockquote>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/CF7AFA06CF68B541FA57E23FC4404C80.png" alt=""></p>
<p>这里需要我们输入密码，这个密码也就是我们导出p12文件时的密码，也就是我们上面设置的abc123。然后，需要我们对生成的pem文件设置一个密语，这里我们推荐还是用上面这个abc123,防止混乱（当然你也可以设置成别的更有意义的密语），这里的密语是要告诉我们服务器的。这样，桌面上又会生成一个PushChatKey.pem文件</p>
<p>3、对生成的这两个pem文件再生成一个pem文件，来把证书和私钥整合到一个文件里：</p>
<blockquote>
<p>cat PushChatCert.pem PushChatKey.pem > ck.pem</p>
</blockquote>
<p>生成ck.pem文件</p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/88681E6EB895AC2C22562F2876BBEBBE.png" alt=""></p>
<p>这样，我们的文件就制作完了。下面进入测试阶段<br>为了测试证书是否工作，执行下面的命令：</p>
<blockquote>
<p>telnet gateway.sandbox.push.apple.com 2195</p>
</blockquote>
<p>它将尝试发送一个规则的，不加密的连接到APNS服务。如果你看到上面的反馈，那说明你的MAC能够到达APNS。按下Ctrl+C关闭连接。如果得到一个错误信息，那么你需要确保你的防火墙允许2195端口。一般这里都不会出现什么问题。</p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/EEB7844AEF2C2D9793AD71E0CCB182E5.png" alt=""></p>
<p>下面我们要使用我们生成的SSL证书和私钥来设置一个安全的链接去链接苹果服务器：</p>
<blockquote>
<p>openssl s_client -connect gateway.sandbox.push.apple.com:2195 -cert PushChatCert.pem -key PushChatKey.pem</p>
</blockquote>
<p>执行完这一句命令后需要我们输入密语<br>Enter pass phrase for PushChatKey.pem:<br>我们输入abcabc按回车<br>你会看到一个完整的输出，让你明白OpenSSL在后台做什么。如果链接是成功的，你可以随便输入一个字符，按下回车，服务器就会断开链接，如果建立连接时有问题，OpenSSL会给你返回一个错误信息。</p>
<p>当你在最后的时候你看到这样说明你已经成功了：</p>
<blockquote>
<p>CONNECTED(00000003)<br>depth=1 /C=US/O=Entrust, Inc./OU=<a href="https://link.jianshu.com/?t=http://www.entrust.net/rpa" target="_blank" rel="noopener">www.entrust.net/rpa</a> isincorporated by reference/OU=(c) 2009 Entrust, Inc./CN=Entrust CertificationAuthority - L1C<br>verify error:num=20:unable to get local issuercertificate<br>verify return:0<br>Certificate chain<br>0s:/C=US/ST=California/L=Cupertino/O=Apple >Inc./OU=iTMSEngineering/CN=gateway.sandbox.push.apple.com<br>i:/C=US/O=Entrust, Inc./OU=<a href="https://link.jianshu.com/?t=http://www.entrust.net/rpa" target="_blank" rel="noopener">www.entrust.net/rpa</a> is incorporated byreference/OU=(c) 2009 Entrust, Inc./CN=Entrust Certification Authority - L1C<br>1s:/C=US/O=Entrust, Inc./OU=<a href="https://link.jianshu.com/?t=http://www.entrust.net/rpa" target="_blank" rel="noopener">www.entrust.net/rpa</a> is incorporated byreference/OU=(c) 2009 Entrust, Inc./CN=Entrust Certification Authority - L1C<br>i:/O=<a href="https://link.jianshu.com/?t=http://Entrust.net/OU=www.entrust.net/CPS_2048incorp" target="_blank" rel="noopener">Entrust.net/OU=www.entrust.net/CPS_2048incorp</a>. by ref. (limits liab.)/OU=(c) 1999 <a href="https://link.jianshu.com/?t=http://Entrust.net" target="_blank" rel="noopener">Entrust.net</a> Limited/CN=Entrust.netCertification Authority (2048)<br>Server certificate<br>—–BEGIN CERTIFICATE—–<br>MIIFGzCCBAOgAwIBAgIETBz90jANBgkqhkiG9w0BAQUFADCBsTELMAkGA1UEBhMC<br>……省略……<br>fMGbLqkGn8YogdPqe5T1<br>—–END CERTIFICATE—–<br>subject=/C=US/ST=California/L=Cupertino/O=AppleInc./OU=iTMS Engineering/CN=gateway.sandbox.push.apple.com<br>issuer=/C=US/O=Entrust, Inc./OU=<a href="https://link.jianshu.com/?t=http://www.entrust.net/rpa" target="_blank" rel="noopener">www.entrust.net/rpa</a> isincorporated by reference/OU=(c) 2009 Entrust, Inc./CN=Entrust CertificationAuthority - L1C<br>No client certificate CA names sent<br>SSL handshake has read 2731 bytes and written 2165 bytes<br>New, TLSv1/SSLv3, Cipher is AES256-SHA<br>Server public key is 2048 bit<br>Secure Renegotiation IS supported<br>Compression: NONE<br>Expansion: NONE<br>SSL-Session:<br>Protocol : TLSv1<br>Cipher : AES256-SHA<br>Session-ID:<br>Session-ID-ctx:<br>Master-Key:C7A47EED5E1F5……省略……369D4<br>Key-Arg : None<br>Start Time:1361862882<br>Timeout : 300 (sec)<br>Verify return code: 0 (ok)</p>
</blockquote>
<p>在这里提醒一下，也许你会看到像我这样的提示：verify error:num=20:unable to get local issuercertificate<br>verify return:0<br>其实是没问题的。</p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/7D192795E857BD7FF32D2BF645F2C02C.png" alt=""></p>
<p>七 项目测试</p>
<p>建立我们的推送的项目（注意BundleIdentifier必须和我们推送应用的App id一致）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">在AppDelegate里didFinishLaunchingWithOptions函数里写</span><br><span class="line">- (BOOL)application:(UIApplication *)applicationdidFinishLaunchingWithOptions:(NSDictionary *)launchOptions</span><br><span class="line">&#123;</span><br><span class="line">    //推送的形式：标记，声音，提示</span><br><span class="line">   [[UIApplication sharedApplication] registerForRemoteNotificationTypes: UIRemoteNotificationTypeBadge |UIRemoteNotificationTypeSound | UIRemoteNotificationTypeAlert];</span><br><span class="line">   return YES;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)application:(UIApplication *)applicationdidRegisterForRemoteNotificationsWithDeviceToken:(NSData *)pToken &#123;</span><br><span class="line">   NSLog(@&quot;regisger success:%@&quot;,pToken);</span><br><span class="line">   //注册成功，将deviceToken保存到应用服务器[数据库](http://lib.csdn.net/base/14)中</span><br><span class="line">&#125;</span><br><span class="line">- (void)application:(UIApplication *)application didReceiveRemoteNotification:(NSDictionary *)userInfo&#123;</span><br><span class="line">    // 处理推送消息</span><br><span class="line">    NSLog(@&quot;userinfo:%@&quot;,userInfo);</span><br><span class="line"></span><br><span class="line">    NSLog(@&quot;收到推送消息:%@&quot;,[[userInfo objectForKey:@&quot;aps&quot;] objectForKey:@&quot;alert&quot;]);</span><br><span class="line">&#125;</span><br><span class="line">- (void)application:(UIApplication *)applicationdidFailToRegisterForRemoteNotificationsWithError:(NSError *)error &#123;</span><br><span class="line">   NSLog(@&quot;Registfail%@&quot;,error); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们运行程序的时候会有提示，说我们的程序要发送推送通知</p>
<p>下面我们把下载的php服务器代码（地址在下面）和生成的ck.pem文件放在统一文件夹下面（这里我们还是把两个文件统一放在桌面上）。<br>用Xcode打开（其他工具也可以）php服务器端的代码，把deviceToken改成我们现在要进行测试的iphone的deviceToken（获得方法：首先运行我们的程序，程序启动后打印的日志文件里可以看到。），密语改成我们之前设置的abc123。然后保存。</p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/C3CF76428AC05EAD0320038CF2CF5F63.png" alt=""></p>
<p>程序中先运行注册拿到deviceToken ,手动给添加，后期可以上传给后台来存储</p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/AA1192271D6864D30F30F453C53659CC.png" alt=""></p>
<p>.PHP中代码修改</p>
<p>然后在终端（记住将终端切换桌面位置 因为你的php后台和推送证书在桌面路径位置）运行命令（如果刚才你关闭了终端的话，最好ls一下，看看当前是不是在桌面），执行命令：<br>php pushMe.php<br>然后回车（pushMe为服务器文件名称）</p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/1CB89172D17E5838CB29FB00283756B4.png" alt=""></p>
<p>如果出现这样的提示说明成功了，然后在iphone上，我们期待已久的推送消息终于来了。</p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/8CDF0120B031DDC8E7B53DFE35E333B7.png" alt=""></p>
<p>IMG_2759.PNG</p>
<h5 id="常见问题："><a href="#常见问题：" class="headerlink" title="常见问题："></a>常见问题：</h5><p>1、在用证书和秘钥链接服务器时出现提示：</p>
<blockquote>
<p>Error opening client certificate private key filePushChatKey.pem20839:error:02001002:system library:fopen:No such file ordirectory:/SourceCache/OpenSSL098/OpenSSL098-44/src/crypto/bio/bss_file.c:356:fopen(‘PushChatKey.pem’,’r’)<br>20839:error:20074002:BIO<br>routines:FILE_CTRL:systemlib:/SourceCache/OpenSSL098/OpenSSL098-44/src/crypto/bio/bss_file.c:358:<br>unable to load client certificate private key file</p>
</blockquote>
<p>解决：<br>文件路径不对。cd到生成的pem文件路径下再进行链接</p>
<p>2、前期测试没有问题，将ck.pem给服务器，通过服务器进行推送时推送不成功，提示链接APNS失败。<br>解决：一，看一下证书的名称，密语是否正确；二，路径是否正确；然后检查一下库，OpenSSL和libssl；此外apache还要开启OpenSSL权限，确保可以访问pem</p>
<p>3、APNS地址 (<strong>\</strong>一定记住切换地址,好多推送不成功就是地址不对,pushMe.php中的代码地址我已经换成测试的了<strong>\</strong>)<br>测试地址gateway.sandbox.push.apple.com:2195<br>发布地址 gateway.push.apple.com:2195<br>测试的地址用的是沙盒，发布地址是不同的。发布软件的时候记得改过来</p>
<p>4、要注意顺序问题，一定要按照这个顺序来：<br>生成钥匙串请求 –>配置下载开发证书–> 配置App ID ，配置、下载SSL证书–>Provisioning证书</p>
<h4 id="实例代码-和-pushMe-php"><a href="#实例代码-和-pushMe-php" class="headerlink" title="实例代码 和 pushMe.php"></a>实例代码 和 pushMe.php</h4><p>下载地址：github: <a href="https://link.jianshu.com/?t=https://github.com/one-tea/APNS_test.git" target="_blank" rel="noopener">https://github.com/one-tea/APNS_test.git</a><br>有什么问题可以与我私信，如果喜欢请关注！<br>后台的配置问题<br>在这里说下后台配置，主要分两类:<br>一. Java、PHP可以通用,上面pushMe.php也就是适用代码；</p>
<p>二. 另一种有.net后台的（比如我们公司），给后台证书为.p12格式 制作方法：<br>在钥匙中找到你安装过的推送证书，记不住就返回上面证书配置那块看</p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/43B9F1E7DA092833795711CC314AF914.png" alt=""></p>
<p>Snip20160803_12.png</p>
<p><img src="/blog/2017/01/02/iOS 推送注册流程/DD9F27DBF3ADB5F11779CD5EB5E3C53E.png" alt=""></p>
<p>Snip20160803_13.png</p>
<p>导出为.p12，密钥也为abc123好了, 这个秘钥需要和.p12一起给后台<br>至于后台有写好的代码 .net 项目中引PushSharp.Apple.dll,PushSharp.Core.dll(这两个文件在网上搜一下，有源码的)</p>

            </div>
          

    
      <footer class="post-footer">
		
		<div class="post-tags">
		  
			<a href="../../../../tags/OC、Swift/">OC、Swift</a>
		  
		</div>
		

        
        
  <nav class="post-nav">
    
      <a class="prev" href="../iOS 推送原理/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">iOS 推送原理</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
  </nav>

        
  <div class="comments" id="comments">
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2014 -
    
    2020
    <span class="footer-author">kris.</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear">Polar Bear</a>
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    


    




  
    <script type="text/javascript" src="../../../../lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="../../../../js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="../../../../js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>
